version: '3.8'

services:
  # Combined application service
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: video-review-app
    ports:
      - "${PORT:-3001}:${PORT:-3001}"
    environment:
      - NODE_ENV=production
      - PORT=${PORT:-3001}
      # AWS credentials (set these in your environment or .env file)
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - S3_BUCKET=${S3_BUCKET}
      # Application settings
      - LOCAL_CACHE_DIR=/data
      - MAX_LOCAL_CACHE_SIZE=1073741824  # 1GB for container environments
      - ENABLE_LOCAL_CACHE=true
      - DEBUG=${DEBUG:-false}  # Set to 'true' to enable verbose debug logging
      # FFmpeg memory optimization settings
      - FFMPEG_THREADS=${FFMPEG_THREADS:-2}
      - FFMPEG_PRESET=${FFMPEG_PRESET:-veryfast}
      - FFMPEG_CRF=${FFMPEG_CRF:-25}
      - FFMPEG_BUFSIZE=${FFMPEG_BUFSIZE:-1M}
      - FFMPEG_MAXRATE=${FFMPEG_MAXRATE:-1000k}
    volumes:
      # Mount volume for temporary video files and cache
      - video_cache:/data
      # Optional: mount for logs
      - ./logs:/app/logs
    networks:
      - video-review-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PORT:-3001}/", "&&", "curl", "-f", "http://localhost:${PORT:-3001}/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  # Persistent volume for video cache
  video_cache:
    driver: local

networks:
  video-review-network:
    driver: bridge